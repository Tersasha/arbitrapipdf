name: Bpium Patch Catalog Fields (append-only)

on:
  workflow_dispatch:
    inputs:
      catalog_id:
        description: "Bpium catalog id to patch"
        required: true
        default: "45"
      preset:
        description: "Preset to apply"
        required: true
        default: "results45_enrich_mvp"
  schedule:
    - cron: "0 0 * * 0"

permissions:
  contents: read

concurrency:
  group: bpium-patch-catalog
  cancel-in-progress: false

jobs:
  patch:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Patch catalog fields (append-only)
        shell: bash
        env:
          BPIUM_DOMAIN: ${{ secrets.BPIUM_DOMAIN }}
          BPIUM_LOGIN: ${{ secrets.BPIUM_LOGIN }}
          BPIUM_PASSWORD: ${{ secrets.BPIUM_PASSWORD }}
        run: |
          set -euo pipefail
          CID="${{ github.event.inputs.catalog_id || '45' }}"
          PRESET="${{ github.event.inputs.preset || 'results45_enrich_mvp' }}"
          python bpium_patch_catalog_fields.py --domain "${BPIUM_DOMAIN}" --catalog-id "${CID}" --preset "${PRESET}"
