name: "(Deprecated) Bpium PdfText Backfill (manual)"

on:
  workflow_dispatch:
    inputs:
      record_id:
        description: "Bpium record id to process (optional). Leave empty to scan catalog and fill empty PdfText."
        required: false
        default: ""
      budget:
        description: "Max parser-api calls per run"
        required: true
        default: "10"
      page_size:
        description: "Bpium page size when scanning"
        required: true
        default: "100"
      max_scan:
        description: "Max Bpium records to scan per run"
        required: true
        default: "2000"
      retry_errors:
        description: "Retry records with PdfTextStatus=error (true/false)"
        required: true
        default: "true"
      cooldown_hours:
        description: "Skip recently-attempted records unless --force (hours)"
        required: true
        default: "24"
      filters_json:
        description: "Bpium filters JSON (optional). Example: {\"7\":\"kad.arbitr.ru\"}. Use {} to disable default filter."
        required: false
        default: ""
      force:
        description: "Process even if PdfText already exists (true/false)"
        required: true
        default: "false"
      dry_run:
        description: "Do not write to Bpium (true/false)"
        required: true
        default: "false"
      debug:
        description: "Include skip reason statistics in output (true/false)"
        required: true
        default: "false"

  # NOTE: schedule disabled (pipeline is handled by bpium_kad_pipeline.yml)

permissions:
  contents: read

jobs:
  backfill:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    concurrency:
      group: bpium-pdftext-backfill
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run worker
        shell: bash
        env:
          BPIUM_DOMAIN: ${{ secrets.BPIUM_DOMAIN }}
          BPIUM_LOGIN: ${{ secrets.BPIUM_LOGIN }}
          BPIUM_PASSWORD: ${{ secrets.BPIUM_PASSWORD }}
          PARSER_API_KEY: ${{ secrets.PARSER_API_KEY }}

          # Optional overrides (kept as secrets for compatibility; script has safe defaults).
          BPIUM_CATALOG_ID: ${{ secrets.BPIUM_CATALOG_ID }}
          BPIUM_FIELD_PDF_URL: ${{ secrets.BPIUM_FIELD_PDF_URL }}
          BPIUM_FIELD_PDF_TEXT: ${{ secrets.BPIUM_FIELD_PDF_TEXT }}
          BPIUM_FIELD_PDF_TEXT_FETCHED_AT: ${{ secrets.BPIUM_FIELD_PDF_TEXT_FETCHED_AT }}
          BPIUM_FIELD_PDF_TEXT_STATUS: ${{ secrets.BPIUM_FIELD_PDF_TEXT_STATUS }}
          BPIUM_FIELD_PDF_TEXT_ERROR: ${{ secrets.BPIUM_FIELD_PDF_TEXT_ERROR }}
        run: |
          set -euo pipefail
          # For schedule runs, inputs.* will be empty; use safe defaults.
          RID="${{ github.event.inputs.record_id }}"
          BUDGET="${{ github.event.inputs.budget }}"
          PAGE_SIZE="${{ github.event.inputs.page_size }}"
          MAX_SCAN="${{ github.event.inputs.max_scan }}"
          RETRY_ERRORS="${{ github.event.inputs.retry_errors }}"
          COOLDOWN_HOURS="${{ github.event.inputs.cooldown_hours }}"
          FILTERS_JSON="${{ github.event.inputs.filters_json }}"
          FORCE="${{ github.event.inputs.force }}"
          DRY="${{ github.event.inputs.dry_run }}"
          DEBUG="${{ github.event.inputs.debug }}"

          # Schedule defaults (small batch).
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            RID=""
            BUDGET="10"
            PAGE_SIZE="100"
            MAX_SCAN="2000"
            RETRY_ERRORS="true"
            COOLDOWN_HOURS="24"
            FILTERS_JSON=""
            FORCE="false"
            DRY="false"
            DEBUG="false"
          fi

          ARGS=(--budget "$BUDGET" --page-size "$PAGE_SIZE" --max-scan "$MAX_SCAN" --cooldown-hours "$COOLDOWN_HOURS")
          if [[ -n "${RID}" ]]; then ARGS+=(--record-id "$RID"); fi
          if [[ -n "${FILTERS_JSON}" ]]; then ARGS+=(--filters-json "$FILTERS_JSON"); fi
          if [[ "${RETRY_ERRORS}" == "true" ]]; then ARGS+=(--retry-errors); fi
          if [[ "${FORCE}" == "true" ]]; then ARGS+=(--force); fi
          if [[ "${DRY}" == "true" ]]; then ARGS+=(--dry-run); fi
          if [[ "${DEBUG}" == "true" ]]; then ARGS+=(--debug-skip-reasons); fi

          python bpium_pdftext_worker.py "${ARGS[@]}" | tee backfill_out.json

          python - <<'PY'
          import json, os
          p = "backfill_out.json"
          with open(p, "r", encoding="utf-8") as f:
            d = json.load(f)
          api = int(d.get("apiCalls") or 0)
          ok = d.get("okCount")
          empty = d.get("emptyCount")
          err = d.get("errorCount")
          scanned = d.get("scanned")
          processed = d.get("processed")
          line = f"parser-api calls used: {api}; scanned={scanned}; processed={processed}; pdf ok/empty/err={ok}/{empty}/{err}"
          print(line)
          summ = os.environ.get("GITHUB_STEP_SUMMARY")
          if summ:
            with open(summ, "a", encoding="utf-8") as sf:
              sf.write("### Parser-API budget\\n")
              sf.write(line + "\\n")
          PY
