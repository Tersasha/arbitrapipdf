name: Bpium PdfText Backfill

on:
  workflow_dispatch:
    inputs:
      record_id:
        description: "Bpium record id to process (optional). Leave empty to scan catalog and fill empty PdfText."
        required: false
        default: ""
      budget:
        description: "Max parser-api calls per run"
        required: true
        default: "10"
      page_size:
        description: "Bpium page size when scanning"
        required: true
        default: "100"
      max_scan:
        description: "Max Bpium records to scan per run"
        required: true
        default: "2000"
      retry_errors:
        description: "Retry records with PdfTextStatus=error (true/false)"
        required: true
        default: "true"
      cooldown_hours:
        description: "Skip recently-attempted records unless --force (hours)"
        required: true
        default: "24"
      force:
        description: "Process even if PdfText already exists (true/false)"
        required: true
        default: "false"
      dry_run:
        description: "Do not write to Bpium (true/false)"
        required: true
        default: "false"

  schedule:
    # Automatic backfill in small batches to protect parser-api limits.
    - cron: "17 * * * *"

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: bpium-pdftext-backfill
      cancel-in-progress: false
    env:
      BPIUM_DOMAIN: ${{ secrets.BPIUM_DOMAIN }}
      BPIUM_LOGIN: ${{ secrets.BPIUM_LOGIN }}
      BPIUM_PASSWORD: ${{ secrets.BPIUM_PASSWORD }}
      PARSER_API_KEY: ${{ secrets.PARSER_API_KEY }}

      # Optional overrides (secrets). Default values are in the script.
      BPIUM_CATALOG_ID: ${{ secrets.BPIUM_CATALOG_ID }}
      BPIUM_FIELD_PDF_URL: ${{ secrets.BPIUM_FIELD_PDF_URL }}
      BPIUM_FIELD_PDF_TEXT: ${{ secrets.BPIUM_FIELD_PDF_TEXT }}
      BPIUM_FIELD_PDF_TEXT_FETCHED_AT: ${{ secrets.BPIUM_FIELD_PDF_TEXT_FETCHED_AT }}
      BPIUM_FIELD_PDF_TEXT_STATUS: ${{ secrets.BPIUM_FIELD_PDF_TEXT_STATUS }}
      BPIUM_FIELD_PDF_TEXT_ERROR: ${{ secrets.BPIUM_FIELD_PDF_TEXT_ERROR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Preflight (secrets/inputs)
        shell: bash
        run: |
          set -euo pipefail

          missing=()
          [[ -z "${BPIUM_DOMAIN:-}" ]] && missing+=("BPIUM_DOMAIN")
          [[ -z "${BPIUM_LOGIN:-}" ]] && missing+=("BPIUM_LOGIN")
          [[ -z "${BPIUM_PASSWORD:-}" ]] && missing+=("BPIUM_PASSWORD")
          [[ -z "${PARSER_API_KEY:-}" ]] && missing+=("PARSER_API_KEY")

          if (( ${#missing[@]} > 0 )); then
            echo "::error title=Missing GitHub Secrets::${missing[*]}"
            exit 1
          fi

          if [[ "${BPIUM_DOMAIN}" != http*://* ]]; then
            echo "::error title=Invalid BPIUM_DOMAIN::Expected full base URL like https://mtkkidney.bpium.ru (got '${BPIUM_DOMAIN}')"
            exit 1
          fi

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run worker
        shell: bash
        run: |
          set -euo pipefail
          # For schedule runs, inputs.* will be empty; use safe defaults.
          RID="${{ github.event.inputs.record_id }}"
          BUDGET="${{ github.event.inputs.budget }}"
          PAGE_SIZE="${{ github.event.inputs.page_size }}"
          MAX_SCAN="${{ github.event.inputs.max_scan }}"
          RETRY_ERRORS="${{ github.event.inputs.retry_errors }}"
          COOLDOWN_HOURS="${{ github.event.inputs.cooldown_hours }}"
          FORCE="${{ github.event.inputs.force }}"
          DRY="${{ github.event.inputs.dry_run }}"

          # Schedule defaults (small batch).
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            RID=""
            BUDGET="10"
            PAGE_SIZE="100"
            MAX_SCAN="2000"
            RETRY_ERRORS="true"
            COOLDOWN_HOURS="24"
            FORCE="false"
            DRY="false"
          fi

          ARGS=(--budget "$BUDGET" --page-size "$PAGE_SIZE" --max-scan "$MAX_SCAN" --cooldown-hours "$COOLDOWN_HOURS")
          if [[ -n "${RID}" ]]; then ARGS+=(--record-id "$RID"); fi
          if [[ "${RETRY_ERRORS}" == "true" ]]; then ARGS+=(--retry-errors); fi
          if [[ "${FORCE}" == "true" ]]; then ARGS+=(--force); fi
          if [[ "${DRY}" == "true" ]]; then ARGS+=(--dry-run); fi

          python bpium_pdftext_worker.py "${ARGS[@]}"
